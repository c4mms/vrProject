<!DOCTYPE html>
<html>
<head>
  <title>Showroom VR - Movimento con joystick</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script>
    AFRAME.registerComponent('joystick-rotation', {
      init: function () {
        const rig = document.querySelector('#rig');

        this.el.addEventListener('axismove', (event) => {
          const x = event.detail.axis[2]; // Rotazione destra/sinistra
          if (Math.abs(x) > 0.1) {
            rig.object3D.rotation.y -= x * 0.03;
          }
        });
      }
    });

    AFRAME.registerComponent('joystick-movement', {
      tick: function () {
        const rig = document.querySelector('#rig');
        const head = document.querySelector('#head');
        const controller = document.querySelector('#leftHand');
        const gamepad = controller.components['tracked-controls']?.controller;

        if (gamepad && gamepad.axes.length >= 4) {
          const y = gamepad.axes[3]; // Avanti/indietro
          if (Math.abs(y) > 0.1) {
            const dir = new THREE.Vector3(0, 0, -y * 0.1);
            dir.applyQuaternion(head.object3D.quaternion);
            rig.object3D.position.add(dir);
          }
        }
      }
    });
  </script>
</head>
<body>
  <a-scene vr-mode-ui="enabled: true">
    <a-assets timeout="20000">
      <a-asset-item id="showroom-model" src="https://showroomcd.s3.amazonaws.com/showroom.glb"></a-asset-item>
    </a-assets>

    <!-- Luci -->
    <a-entity light="type: ambient; intensity: 0.7"></a-entity>
    <a-entity light="type: directional; intensity: 0.5" position="1 3 2"></a-entity>

    <!-- Piano di camminamento -->
    <a-plane rotation="-90 0 0" width="500" height="500" color="#7BC8A4"
             class="teleportable" static-body></a-plane>

    <!-- Modello -->
    <a-entity gltf-model="#showroom-model" position="0 0 0" scale="0.8 0.8 0.8"></a-entity>

    <!-- Rig con camera e controller -->
    <a-entity id="rig" position="0 1.6 10" joystick-movement>
      <a-entity id="head" camera look-controls position="0 0 0"></a-entity>

      <!-- Controller sinistro per camminare -->
      <a-entity id="leftHand"
                laser-controls="hand: left"
                tracked-controls="hand: left"></a-entity>

      <!-- Controller destro per ruotare -->
      <a-entity id="rightHand"
                laser-controls="hand: right"
                tracked-controls="hand: right"
                joystick-rotation></a-entity>
    </a-entity>
  </a-scene>
</body>
</html>
